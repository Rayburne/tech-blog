<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="google" content="notranslate" />
<link rel="icon" href="/images/icon.png" />
<link rel="stylesheet" href="/css/style.css" />

<title>Ansible Dynamic Inventory 的使用 - Youmi Tech Blog. </title>
<script>
var c = {
    name: '',
    url: ''
}
</script>
</head>
<body>

<div class="header">
    <div class="center">
        <h1><a href="/">Youmi Tech Blog.</a></h1>
        <p>I dream of painting and then I paint my dream.</p>
    </div>
    <div class="menu">
        <a href="/">home</a>
        <a href="/archives">archives</a>
    </div>
</div>


<div id="post" class="center">

    <h1>Ansible Dynamic Inventory 的使用</h1>
    <p><a href="https://github.com/zheng-ji">zheng-ji</a> Posted at Apr 04, 2016 . -
    <a href="/category/Ansible/">Ansible</a> -
    <a href="/category/运维/">运维</a> -
    </p>

    <div class="content"><h3 id="ansible-dynamic-inventory-">Ansible Dynamic Inventory 解决的问题</h3>
<p>Ansible 在使用的过程中，如果机器数量比较固定，且变更不多的情况下，可在 <code>/etc/ansible/hosts</code> 文件里面配置固定的组合机器IP，并给他起组的别名，执行 <code>ansible</code> 脚本便可以通过别名找到相应的机器。如下：</p>
<pre><code><span class="hljs-string">[webservers]</span>
<span class="hljs-number">111.222.333.444</span> ansible_ssh_port=<span class="hljs-number">888</span>
</code></pre><p>假如你有很多台机器，且机器经常变更导致IP时常变换，你还想把IP逐个写入 <code>/etc/ansible/hosts</code> 就不现实了。你也许会问，若不把IP写进 <code>/etc/ansible/hosts</code>，那不是没法用 <code>ansible</code> 指挥这些机器？
感谢 <code>Ansible Dynamic Inventory</code>， 如果我们能通过编程等手段获取变更机器的IP，我们还是有办法实现的。</p>
<hr>
<h3 id="dynamic-inventory-">Dynamic Inventory 的原理</h3>
<ul>
<li>通过编程的方式,也就是动态获取机器的 json 信息;</li>
<li>Ansible 通过解析这串 json 字符串;</li>
</ul>
<pre><code>ansible -<span class="hljs-selector-tag">i</span> yourprogram<span class="hljs-selector-class">.py</span> -m raw  -<span class="hljs-selector-tag">a</span> <span class="hljs-string">'cd /home'</span>
</code></pre><p>Ansible dDynamic Inventory 对程序返回的 json 的转义是这样的：</p>
<pre><code>{<span class="hljs-attr">"devtest-asg"</span>: {<span class="hljs-attr">"hosts"</span>: [<span class="hljs-string">"172.31.21.164"</span>], <span class="hljs-attr">"vars"</span>: {<span class="hljs-attr">"ansible_ssh_port"</span>: <span class="hljs-number">12306</span>}}}
</code></pre><p>翻译一下就是  <code>/etc/ansible/hosts</code> 中的:</p>
<pre><code><span class="hljs-string">[devtest-asg]</span>
<span class="hljs-number">172.31.21.164</span> ansible_ssh_port=<span class="hljs-number">12306</span>
</code></pre><hr>
<h3 id="-">一个实战的例子</h3>
<p>官方文档对 Inventory 仅作概念性描述，阅读完后仍是一头雾水，不知如何下手。
让我们用一个例子来豁然开朗吧。
我们使用 AWS 的 AutoScaling Group，以下简称 ASG，ASG 会在某种自定义的条件下会自动开启和关闭机器，这给我们在辨别IP，定位机器的时候造成困扰。因此我们需要　<code>Ansible Dynamic Inventory</code></p>
<p>我们使用 AWS 的｀boto｀库来获取ASG的实例信息.以下程序(get_host.py)中要实现的方法就是列出返回机器信息的 json 串。</p>
<pre><code class="lang-python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> boto
<span class="hljs-keyword">import</span> boto.ec2
<span class="hljs-keyword">import</span> boto.ec2.autoscale

<span class="hljs-type">AWS_REGION</span> = '<span class="hljs-type">BBB</span>'
<span class="hljs-type">AWS_ACCESS_KEY</span> = 'xxxx'
<span class="hljs-type">AWS_SECRET_KEY</span> = 'yyy'

<span class="hljs-literal">result</span> = {}
def getData():
    conn_as = boto.ec2.autoscale.connect_to_region(
            'cn-north-<span class="hljs-number">1</span>',
            aws_access_key_id=<span class="hljs-type">AWS_ACCESS_KEY</span>,
            aws_secret_access_key=<span class="hljs-type">AWS_SECRET_KEY</span>)
    group = conn_as.get_all_groups(names=['devtest-asg'])[<span class="hljs-number">0</span>]
    conn_ec2 = boto.ec2.connect_to_region(
            <span class="hljs-type">AWS_REGION</span>,
            aws_access_key_id=<span class="hljs-type">AWS_ACCESS_KEY</span>,
            aws_secret_access_key=<span class="hljs-type">AWS_SECRET_KEY</span>)

    instance_ids = [i.instance_id <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> group.instances]
    reservations = conn_ec2.get_all_instances(instance_ids)
    instances = [i <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> reservations <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> r.instances]

    <span class="hljs-literal">result</span>['devtest-asg'] = {}
    <span class="hljs-literal">result</span>['devtest-asg']['hosts'] = []
    <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> reservations:
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> r.instances:
            <span class="hljs-literal">result</span>['devtest-asg']['hosts'].append('%s' % i.private_ip_address)
            <span class="hljs-literal">result</span>['devtest-asg']['vars'] = {'ansible_ssh_port': <span class="hljs-number">36000</span>}

def getlists():
    getData()
    print json.dumps(<span class="hljs-literal">result</span>)

getlists()
</code></pre>
<p>执行以下命令就可以愉快地使用 Ansible 了，其中 <code>devtest-asg</code> 是ASG的别名：</p>
<pre><code>ansible -<span class="hljs-selector-tag">i</span> get_host<span class="hljs-selector-class">.py</span>  devtest-asg -m raw -<span class="hljs-selector-tag">a</span> <span class="hljs-string">'ls /'</span>
</code></pre></div>

    <div class="label">
    </div>

    <div class="comment_list hide" id="disqus_thread"></div>
    <div id="duoshuo_thread" class="comment_list hide ds-thread" data-thread-key="145599925" data-title="" data-url=""></div>

    <button class="hide" data-id="145599925" id="comment">Add Comments</button>

</div>

<div class="footer">
    <div class="center">
        © 2016 Youmi Tech Blog. . <a target="_blank" href="https://github.com/AcyOrt/acyort">AcyOrt</a> . <a target="_blank" href="/rss.xml">RSS</a>
    </div>
</div>


<script src="/js/comment.js"></script>
</body>
</html>
